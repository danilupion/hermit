# E2.2: Session Persistence Design

**Date:** 2025-01-28
**Epic:** E2.2 Session Persistence
**Milestone:** M2 Bidirectional I/O

## Overview

Enable terminal output replay when clients reconnect, and automatic session re-attachment when agents reconnect. Uses tmux's native scrollback buffer for zero-overhead history storage.

## Design Decision

**Approach: Agent-side buffering with tmux scrollback**

Alternatives considered:

- **Relay-side buffering:** Simpler but buffer lost on relay restart, doesn't scale horizontally
- **Database persistence:** Overkill for MVP, significant I/O overhead

Why agent-side:

- Leverages tmux's built-in scrollback (already exists, battle-tested)
- Buffer survives agent process restarts (tmux persists)
- Scales naturally - each agent manages its own sessions
- Multiple relay instances work without shared state (future M3)
- Zero additional memory management needed

## Protocol Changes

### New Message: AttachSession (Modified)

**Direction:** Client → Relay → Agent

```typescript
// packages/protocol/src/client-messages.ts
type AttachSessionMessage = {
  type: 'attach_session';
  machineId: string;
  sessionId: string;
  requestReplay?: boolean; // NEW: request scrollback on attach (default: true)
  replayLines?: number; // NEW: how many lines (default: 1000)
};
```

### New Message: SessionReplay

**Direction:** Agent → Relay → Client

```typescript
// packages/protocol/src/agent-messages.ts
type SessionReplayMessage = {
  type: 'session_replay';
  sessionId: string;
  data: string; // Base64-encoded scrollback content
  lineCount: number; // How many lines included
};

// packages/protocol/src/client-messages.ts (for relay → client)
type SessionReplayMessage = {
  type: 'session_replay';
  sessionId: string;
  data: string;
  lineCount: number;
};
```

### Message Flow

```
Client                    Relay                     Agent
   |                        |                         |
   |-- attach_session ----->|                         |
   |   (requestReplay:true) |-- attach_session ------>|
   |                        |                         |
   |                        |<-- session_replay ------|
   |<-- session_replay -----|   (scrollback data)     |
   |                        |                         |
   |<-- data ---------------|<-- data ----------------|
   |   (live stream)        |   (live stream)         |
```

## Implementation Details

### Story 2.2.1: Buffer Output During Client Disconnect

No explicit buffering needed - tmux already maintains scrollback. Implementation:

**Agent: tmux.ts**

```typescript
async function captureScrollback(sessionId: string, lines: number = 1000): Promise<string> {
  // -p: print to stdout
  // -S -N: start N lines from history
  // -e: include escape sequences (colors)
  // -J: join wrapped lines
  const result = await execCommand(
    `tmux capture-pane -t ${quote(sessionId)} -p -S -${lines} -e -J`,
  );
  return result.stdout;
}
```

### Story 2.2.2: Replay Buffered Output on Reconnect

**Agent: connect.ts message handler**

```typescript
case 'attach_session':
  const { sessionId, requestReplay, replayLines } = msg;

  if (requestReplay !== false) {
    const scrollback = await tmux.captureScrollback(sessionId, replayLines ?? 1000);
    const encoded = Buffer.from(scrollback).toString('base64');
    relayConnection.send({
      type: 'session_replay',
      sessionId,
      data: encoded,
      lineCount: replayLines ?? 1000
    });
  }

  // Start live streaming (existing logic)
  attachToSession(sessionId);
  break;
```

**Relay: agent-handler.ts**

```typescript
case 'session_replay':
  broadcastToClients(state.machineId, msg.sessionId, {
    type: 'session_replay',
    sessionId: msg.sessionId,
    data: msg.data,
    lineCount: msg.lineCount
  });
  break;
```

**Relay: client-handler.ts**

```typescript
case 'attach_session':
  const { sessionId, machineId, requestReplay, replayLines } = msg;

  attachClientToSession(state.clientId, sessionId, machineId);

  const agent = getAgent(machineId);
  if (agent) {
    agent.ws.send(JSON.stringify({
      type: 'attach_session',
      sessionId,
      clientId: state.clientId,
      requestReplay: requestReplay ?? true,
      replayLines: replayLines ?? 1000
    }));
  }
  break;
```

**Web: Terminal page message handler**

```typescript
case 'session_replay':
  if (msg.sessionId === sessionId) {
    const decoded = atob(msg.data);
    terminalRef.current?.clear();
    terminalRef.current?.write(decoded);
  }
  break;
```

**Web: relay store**

```typescript
attachToSession(machineId: string, sessionId: string, requestReplay = true) {
  this.send({
    type: 'attach_session',
    machineId,
    sessionId,
    requestReplay,
    replayLines: 1000
  });
}
```

### Story 2.2.3: Agent Reconnection with Session Sync

When agent reconnects, relay automatically re-attaches any clients that were viewing its sessions.

**Relay: agent-handler.ts (after sessions_list received)**

```typescript
case 'sessions_list':
  updateAgentSessions(state.machineId, msg.sessions);

  // Re-attach clients that were viewing these sessions
  for (const session of msg.sessions) {
    const attachedClients = getClientsAttachedToSession(state.machineId, session.id);
    if (attachedClients.length > 0) {
      ws.send(JSON.stringify({
        type: 'attach_session',
        sessionId: session.id,
        requestReplay: false,  // Clients already have context
      }));
    }
  }
  break;
```

**Client registry must preserve attachments during agent disconnect:**

- Currently: client attachments are tracked in relay memory
- No change needed - attachments survive agent disconnect
- When agent returns, relay triggers re-attachment

## Edge Cases

| Scenario                             | Behavior                                         |
| ------------------------------------ | ------------------------------------------------ |
| Client disconnects, reconnects       | Requests replay, gets scrollback + live stream   |
| Agent disconnects, reconnects        | Relay re-attaches existing clients automatically |
| Client attaches while agent offline  | Gets error response, can retry when agent online |
| Multiple clients attach same session | Each gets replay independently on their attach   |
| Relay restarts                       | Client attachments lost, clients must re-attach  |
| tmux session has no scrollback       | Empty replay sent, live stream continues         |

## Out of Scope (M3+)

- Persistent attachment tracking (survives relay restart)
- Exponential backoff on client reconnect (currently fixed 2s)
- Buffering on relay during agent disconnect
- Configurable scrollback per-session from web UI

## Testing Strategy

**Unit tests:**

- `tmux.captureScrollback()` - mock exec, verify command and encoding
- Protocol schema validation for new message types

**Integration tests:**

- Replay message flow: client attach → agent capture → relay forward → client receive
- Agent reconnection: simulate disconnect/reconnect, verify client re-attachment

**Manual testing:**

- Open terminal, generate output, close tab, reopen - verify history shows
- Kill agent process, restart - verify terminal resumes

## Files to Modify

| File                                                         | Changes                                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------------------ |
| `packages/protocol/src/agent-messages.ts`                    | Add `SessionReplayMessage` type and schema                               |
| `packages/protocol/src/client-messages.ts`                   | Add `requestReplay`, `replayLines` to attach; add `SessionReplayMessage` |
| `apps/agent/src/tmux.ts`                                     | Add `captureScrollback()` function                                       |
| `apps/agent/src/commands/connect.ts`                         | Handle replay in `attach_session`                                        |
| `apps/relay/src/ws/agent-handler.ts`                         | Forward `session_replay`, re-attach on reconnect                         |
| `apps/relay/src/ws/client-handler.ts`                        | Forward replay fields to agent                                           |
| `apps/web/src/stores/relay.ts`                               | Add replay fields to `attachToSession()`                                 |
| `apps/web/src/hooks/useWebSocket.ts`                         | Handle `session_replay` message                                          |
| `apps/web/src/app/machines/[machineId]/[sessionId]/page.tsx` | Write replay to terminal                                                 |

## Implementation Order

1. **Protocol changes** - Add new message types and schemas
2. **Agent tmux capture** - Implement `captureScrollback()`
3. **Agent attach handler** - Send replay on attach
4. **Relay forwarding** - Pass replay messages through
5. **Web client** - Handle replay and display
6. **Agent reconnect sync** - Re-attach clients on agent return
7. **Tests** - Unit and integration tests throughout
